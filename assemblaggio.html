<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JD Manager - Assemblaggio</title>
  <link rel="stylesheet" href="style.css">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, update } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCppFhxRO8NatltrmBXqUXGj-cWG5X8wdU",
      authDomain: "jd-manager-quello-definitivo.firebaseapp.com",
      databaseURL: "https://jd-manager-quello-definitivo-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "jd-manager-quello-definitivo",
      storageBucket: "jd-manager-quello-definitivo.firebasestorage.app",
      messagingSenderId: "412067831707",
      appId: "1:412067831707:web:4b61a8a3c0477cc830cb3e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tableBody = document.getElementById("tableBody");
    const ordersRef = ref(db, "assemblaggio");

    onValue(ordersRef, snapshot => {
      tableBody.innerHTML = "";
      const data = snapshot.val() || {};
      Object.entries(data).forEach(([id, ordine]) => addRowFromData(id, ordine));
    });

    function addRowFromData(id, ordine) {
      const row = document.createElement("tr");

      const codice = document.createElement("td");
      codice.innerHTML = `<input value="${ordine.codice || ""}" oninput="updateOrder('${id}', 'codice', this.value)">`;
      row.appendChild(codice);

      const s1 = document.createElement("td");
      s1.style.backgroundColor = ordine.s1 || "white";
      s1.onclick = () => toggleState(id, "s1", s1, ["white", "red"]);
      row.appendChild(s1);

      const s2 = document.createElement("td");
      s2.style.backgroundColor = ordine.s2 || "white";
      s2.onclick = () => toggleState(id, "s2", s2, ["white", "orange"]);
      row.appendChild(s2);

      const cliente = document.createElement("td");
      cliente.innerHTML = `<input value="${ordine.cliente || ""}" oninput="updateOrder('${id}', 'cliente', this.value)">`;
      row.appendChild(cliente);

      const formato = document.createElement("td");
      formato.innerHTML = `<input value="${ordine.formato || ""}" oninput="updateOrder('${id}', 'formato', this.value)">`;
      row.appendChild(formato);

      tableBody.appendChild(row);
    }

    window.addRow = function() {
      push(ordersRef, {
        codice: "",
        s1: "white",
        s2: "white",
        cliente: "",
        formato: ""
      });
    };

    const pendingUpdates = {};
    window.updateOrder = function(id, field, value) {
      if (pendingUpdates[id + field]) clearTimeout(pendingUpdates[id + field]);
      pendingUpdates[id + field] = setTimeout(() => {
        const orderRef = ref(db, `assemblaggio/${id}`);
        update(orderRef, { [field]: value });
      }, 500);
    };

    window.toggleState = function(id, field, cell, colors) {
      const next = colors[(colors.indexOf(cell.style.backgroundColor) + 1) % colors.length];
      cell.style.backgroundColor = next;
      const orderRef = ref(db, `assemblaggio/${id}`);
      update(orderRef, { [field]: next });
    };

    window.searchTable = function() {
      const term = document.getElementById("search").value.toLowerCase();
      const rows = tableBody.querySelectorAll("tr");
      rows.forEach(r => {
        const codice = r.cells[0].querySelector("input").value.toLowerCase();
        const cliente = r.cells[3].querySelector("input").value.toLowerCase();
        r.style.display = codice.includes(term) || cliente.includes(term) ? "" : "none";
      });
    };
  </script>
</head>
<body>
  <header>üõ†Ô∏è Assemblaggio</header>
  <main>
    <div class="search-bar">
      üîç <input type="text" id="search" placeholder="Cerca per codice o cliente..." onkeyup="searchTable()">
    </div>
    <table>
      <thead>
        <tr>
          <th>Codice Ordine</th>
          <th>Stato 1</th>
          <th>Stato 2</th>
          <th>Nome Cliente</th>
          <th>Formato Ordine</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <button onclick="addRow()">‚ûï Aggiungi Ordine</button>
  </main>
</body>
</html>
