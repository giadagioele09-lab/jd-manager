<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JD Manager - Magazzino</title>
  <link rel="stylesheet" href="style.css">
  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, update } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

    // Configurazione JD Manager
    const firebaseConfig = {
      apiKey: "AIzaSyCppFhxRO8NatltrmBXqUXGj-cWG5X8wdU",
      authDomain: "jd-manager-quello-definitivo.firebaseapp.com",
      databaseURL: "https://jd-manager-quello-definitivo-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "jd-manager-quello-definitivo",
      storageBucket: "jd-manager-quello-definitivo.firebasestorage.app",
      messagingSenderId: "412067831707",
      appId: "1:412067831707:web:4b61a8a3c0477cc830cb3e"
    };

    // Inizializza Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tableBody = document.getElementById("tableBody");
    const ordersRef = ref(db, "magazzino");

    // Quando i dati cambiano, aggiorna la tabella
    onValue(ordersRef, snapshot => {
      tableBody.innerHTML = "";
      const data = snapshot.val() || {};
      Object.entries(data).forEach(([id, ordine]) => addRowFromData(id, ordine));
    });

    // Aggiunge una riga dalla memoria del DB
    function addRowFromData(id, ordine) {
      const row = document.createElement("tr");

      const codice = document.createElement("td");
      codice.innerHTML = `<input value="${ordine.codice || ""}" oninput="updateOrder('${id}', 'codice', this.value)">`;
      row.appendChild(codice);

      const s1 = document.createElement("td");
      s1.style.backgroundColor = ordine.s1 || "white";
      s1.onclick = () => toggleState(id, "s1", s1, ["white", "yellow"]);
      row.appendChild(s1);

      const s2 = document.createElement("td");
      s2.style.backgroundColor = ordine.s2 || "white";
      s2.onclick = () => toggleState(id, "s2", s2, ["white", "green"]);
      row.appendChild(s2);

      const cliente = document.createElement("td");
      cliente.innerHTML = `<input value="${ordine.cliente || ""}" oninput="updateOrder('${id}', 'cliente', this.value)">`;
      row.appendChild(cliente);

      const formato = document.createElement("td");
      formato.innerHTML = `<input value="${ordine.formato || ""}" oninput="updateOrder('${id}', 'formato', this.value)">`;
      row.appendChild(formato);

      const tipologia = document.createElement("td");
      tipologia.innerHTML = `<input value="${ordine.tipologia || ""}" oninput="updateOrder('${id}', 'tipologia', this.value)">`;
      colorTip(tipologia.firstChild);
      row.appendChild(tipologia);

      tableBody.appendChild(row);
    }

    // Aggiungi nuovo ordine
    window.addRow = function() {
      push(ordersRef, {
        codice: "",
        s1: "white",
        s2: "white",
        cliente: "",
        formato: "",
        tipologia: ""
      });
    };

    // Aggiorna un campo dell'ordine
    window.updateOrder = function(id, field, value) {
      const orderRef = ref(db, `magazzino/${id}`);
      update(orderRef, { [field]: value });
    };

    // Cambia stato con clic
    window.toggleState = function(id, field, cell, colors) {
      const next = colors[(colors.indexOf(cell.style.backgroundColor) + 1) % colors.length];
      cell.style.backgroundColor = next;
      const orderRef = ref(db, `magazzino/${id}`);
      update(orderRef, { [field]: next });
    };

    // Colore automatico per tipologia
    window.colorTip = function(input) {
      const val = input.value.toLowerCase();
      let color = "white";
      if (val.includes("bloom")) color = "cyan";
      if (val.includes("fotolibro")) color = "lightgreen";
      if (val.includes("kit smart")) color = "#e4d96f";
      if (val.includes("ottawa")) color = "fuchsia";
      input.style.backgroundColor = color;
    };

    // Ricerca
    window.searchTable = function() {
      const term = document.getElementById("search").value.toLowerCase();
      const rows = tableBody.querySelectorAll("tr");
      rows.forEach(r => {
        const codice = r.cells[0].querySelector("input").value.toLowerCase();
        const cliente = r.cells[3].querySelector("input").value.toLowerCase();
        r.style.display = codice.includes(term) || cliente.includes(term) ? "" : "none";
      });
    };
  </script>
</head>
<body>
  <header>üì¶ Magazzino</header>
  <main>
    <div class="search-bar">
      üîç <input type="text" id="search" placeholder="Cerca per codice o cliente..." onkeyup="searchTable()">
    </div>
    <table>
      <thead>
        <tr>
          <th>Codice Ordine</th>
          <th>Stato 1</th>
          <th>Stato 2</th>
          <th>Nome Cliente</th>
          <th>Formato Ordine</th>
          <th>Tipologia Merce</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <button onclick="addRow()">‚ûï Aggiungi Ordine</button>
  </main>
</body>
</html>
